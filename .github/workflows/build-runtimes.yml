name: Build Runtime Libraries

on:
  push:
    paths:
      - 'runtime-build/**'
    branches: [main]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Linux x64 libraries
        run: |
          cd runtime-build
          for backend in cpu cuda rocm webgpu; do
            echo "Building libmind_${backend}_linux-x64.so..."
            gcc -shared -fPIC -O2 \
              -fstack-protector-strong \
              -D_FORTIFY_SOURCE=2 \
              -fvisibility=hidden \
              -Wl,-z,relro,-z,now \
              -Wl,--gc-sections \
              -fdata-sections -ffunction-sections \
              -o "libmind_${backend}_linux-x64.so" \
              runtime_cpu.c \
              -ldl -lpthread
            strip --strip-all "libmind_${backend}_linux-x64.so"
          done

          echo "Building libmind_runtime.so..."
          gcc -shared -fPIC -O2 \
            -fstack-protector-strong \
            -D_FORTIFY_SOURCE=2 \
            -fvisibility=hidden \
            -Wl,-z,relro,-z,now \
            -Wl,--gc-sections \
            -fdata-sections -ffunction-sections \
            -o "libmind_runtime_linux-x64.so" \
            runtime_cpu.c \
            -ldl -lpthread
          strip --strip-all "libmind_runtime_linux-x64.so"

          ls -la *.so

      - uses: actions/upload-artifact@v4
        with:
          name: linux-x64-libs
          path: runtime-build/*.so

  build-macos-arm64:
    runs-on: macos-14  # M1 runner
    steps:
      - uses: actions/checkout@v4

      - name: Build macOS ARM64 libraries
        run: |
          cd runtime-build
          for backend in cpu cuda rocm webgpu metal; do
            echo "Building libmind_${backend}_macos-arm64.dylib..."
            clang -arch arm64 -O2 -fPIC \
              -fstack-protector-strong \
              -fvisibility=hidden \
              -fdata-sections -ffunction-sections \
              -dynamiclib -ldl -lpthread \
              -Wl,-dead_strip \
              -o "libmind_${backend}_macos-arm64.dylib" \
              runtime_cpu.c
            strip -x "libmind_${backend}_macos-arm64.dylib"
          done

          echo "Building libmind_runtime_macos-arm64.dylib..."
          clang -arch arm64 -O2 -fPIC \
            -fstack-protector-strong \
            -fvisibility=hidden \
            -fdata-sections -ffunction-sections \
            -dynamiclib -ldl -lpthread \
            -Wl,-dead_strip \
            -o "libmind_runtime_macos-arm64.dylib" \
            runtime_cpu.c
          strip -x "libmind_runtime_macos-arm64.dylib"

          ls -la *.dylib

      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-libs
          path: runtime-build/*.dylib

  build-macos-x64:
    runs-on: macos-13  # Intel runner
    steps:
      - uses: actions/checkout@v4

      - name: Build macOS x64 libraries
        run: |
          cd runtime-build
          for backend in cpu cuda rocm webgpu metal; do
            echo "Building libmind_${backend}_macos-x64.dylib..."
            clang -arch x86_64 -O2 -fPIC \
              -fstack-protector-strong \
              -fvisibility=hidden \
              -fdata-sections -ffunction-sections \
              -dynamiclib -ldl -lpthread \
              -Wl,-dead_strip \
              -o "libmind_${backend}_macos-x64.dylib" \
              runtime_cpu.c
            strip -x "libmind_${backend}_macos-x64.dylib"
          done

          echo "Building libmind_runtime_macos-x64.dylib..."
          clang -arch x86_64 -O2 -fPIC \
            -fstack-protector-strong \
            -fvisibility=hidden \
            -fdata-sections -ffunction-sections \
            -dynamiclib -ldl -lpthread \
            -Wl,-dead_strip \
            -o "libmind_runtime_macos-x64.dylib" \
            runtime_cpu.c
          strip -x "libmind_runtime_macos-x64.dylib"

          ls -la *.dylib

      - uses: actions/upload-artifact@v4
        with:
          name: macos-x64-libs
          path: runtime-build/*.dylib

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2

      - name: Build Windows x64 libraries
        shell: cmd
        run: |
          cd target\runtime-build
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

          for %%b in (cpu cuda rocm webgpu directx) do (
            echo Building mind_%%b_windows-x64.dll...
            cl /O2 /GS /DYNAMICBASE /NXCOMPAT /LD runtime_cpu.c /Fe:mind_%%b_windows-x64.dll /link /DLL
          )

          echo Building mind_runtime_windows-x64.dll...
          cl /O2 /GS /DYNAMICBASE /NXCOMPAT /LD runtime_cpu.c /Fe:mind_runtime_windows-x64.dll /link /DLL

          dir *.dll

      - uses: actions/upload-artifact@v4
        with:
          name: windows-x64-libs
          path: runtime-build/*.dll

  package-release:
    needs: [build-linux, build-macos-arm64, build-macos-x64, build-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: libs

      - name: Package all libraries
        run: |
          mkdir -p release/linux-x64 release/macos-arm64 release/macos-x64 release/windows-x64
          cp libs/linux-x64-libs/* release/linux-x64/
          cp libs/macos-arm64-libs/* release/macos-arm64/
          cp libs/macos-x64-libs/* release/macos-x64/
          cp libs/windows-x64-libs/* release/windows-x64/

          echo "All platform libraries:"
          find release -type f -name "*.so" -o -name "*.dylib" -o -name "*.dll" | sort

      - uses: actions/upload-artifact@v4
        with:
          name: all-platform-libs
          path: release/
