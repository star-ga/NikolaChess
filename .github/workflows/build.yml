# NikolaChess CI/CD Pipeline
# Copyright (c) 2026 STARGA, Inc. All rights reserved.

name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [created]

env:
  MIND_VERSION: "1.0.0"

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install MIND Compiler
        run: |
          curl -sSL https://mindlang.dev/install.sh | bash
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Build CPU Version
        run: mindc build --release --target cpu

      - name: Build CUDA Version
        run: mindc build --release --target cuda

      - name: Run Tests
        run: mindc run tools/perft.mind -- suite

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: |
            target/release/nikola-cpu
            target/release/nikola-cuda

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install MIND Compiler
        run: |
          curl -sSL https://mindlang.dev/install.sh | bash
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Build CPU Version (x64)
        run: mindc build --release --target cpu --arch x64

      - name: Build CPU Version (ARM64)
        run: mindc build --release --target cpu --arch arm64

      - name: Create Universal Binary
        run: |
          lipo -create -output nikola-cpu-universal \
            target/release/nikola-cpu-x64 \
            target/release/nikola-cpu-arm64

      - name: Upload macOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: |
            target/release/nikola-cpu-x64
            target/release/nikola-cpu-arm64
            nikola-cpu-universal

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install MIND Compiler
        run: |
          Invoke-WebRequest -Uri https://mindlang.dev/install.ps1 -OutFile install.ps1
          .\install.ps1

      - name: Build CPU Version
        run: mindc build --release --target cpu

      - name: Build CUDA Version
        run: mindc build --release --target cuda

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-binaries
          path: |
            target/release/nikola-cpu.exe
            target/release/nikola-cuda.exe

  release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    steps:
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-binaries
          path: linux

      - name: Download macOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-binaries
          path: macos

      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-binaries
          path: windows

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            linux/nikola-cpu
            linux/nikola-cuda
            macos/nikola-cpu-x64
            macos/nikola-cpu-arm64
            macos/nikola-cpu-universal
            windows/nikola-cpu.exe
            windows/nikola-cuda.exe
