# NikolaChess CI/CD Pipeline
# Copyright (c) 2026 STARGA, Inc. All rights reserved.

name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [created]
  workflow_dispatch:

env:
  NIKOLACHESS_VERSION: "3.21.0"
  MIND_VERSION: "0.1.2"

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.nikolachess/bin $HOME/.nikolachess/lib
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-linux-x64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.nikolachess/bin/
          chmod +x $HOME/.nikolachess/bin/mindc*
          
          for lib in cpu cuda rocm oneapi webgpu; do
            curl -fsSL -o "$HOME/.nikolachess/lib/libmind_${lib}_linux-x64.so" \
              "https://github.com/star-ga/NikolaChess/releases/download/v${{ env.NIKOLACHESS_VERSION }}/libmind_${lib}_linux-x64.so" || true
          done
          
          echo "$HOME/.nikolachess/bin" >> $GITHUB_PATH
          echo "MIND_LIB_PATH=$HOME/.nikolachess/lib" >> $GITHUB_ENV

      - name: Verify
        run: |
          mindc --version
          ls -lh $HOME/.nikolachess/lib/

      - name: Build
        run: |
          mkdir -p target/release
          mindc build --release --target cpu || mindc src/main.mind --verify-only || true
          echo "MIND Source: $(find src -name '*.mind' | wc -l) files"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: src/*.mind

  build-linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.nikolachess/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-linux-arm64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.nikolachess/bin/
          chmod +x $HOME/.nikolachess/bin/mindc*
          echo "$HOME/.nikolachess/bin" >> $GITHUB_PATH

      - name: Verify
        run: mindc --version

      - name: Build
        run: |
          mkdir -p target/release
          mindc build --release --target cpu || mindc src/main.mind --verify-only || true
          find src -name "*.mind" | wc -l

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: src/*.mind

  build-macos-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.nikolachess/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-macos-arm64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.nikolachess/bin/
          chmod +x $HOME/.nikolachess/bin/mindc*
          echo "$HOME/.nikolachess/bin" >> $GITHUB_PATH

      - name: Verify
        run: mindc --version

      - name: Build
        run: |
          mkdir -p target/release
          mindc build --release --target cpu || mindc src/main.mind --verify-only || true
          find src -name "*.mind" | wc -l

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: src/*.mind

  build-macos-x64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.nikolachess/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-macos-x64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.nikolachess/bin/
          chmod +x $HOME/.nikolachess/bin/mindc*
          echo "$HOME/.nikolachess/bin" >> $GITHUB_PATH

      - name: Verify
        run: mindc --version

      - name: Build
        run: |
          mkdir -p target/release
          mindc build --release --target cpu || mindc src/main.mind --verify-only || true
          find src -name "*.mind" | wc -l

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64
          path: src/*.mind

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.nikolachess\bin"
          Invoke-WebRequest -Uri "https://github.com/star-ga/mind/releases/download/v$env:MIND_VERSION/mindc-windows-x64.zip" -OutFile "$env:TEMP\mindc.zip"
          Expand-Archive -Path "$env:TEMP\mindc.zip" -DestinationPath "$env:USERPROFILE\.nikolachess\bin" -Force
          echo "$env:USERPROFILE\.nikolachess\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify
        shell: pwsh
        run: |
          & "$env:USERPROFILE\.nikolachess\bin\mindc.exe" --version

      - name: Verify Source
        shell: pwsh
        run: |
          # Windows mindc v0.1.2+ supports import statements
          & "$env:USERPROFILE\.nikolachess\bin\mindc.exe" src/main.mind --verify-only
          Write-Host "MIND files: $((Get-ChildItem -Path src -Filter *.mind -Recurse).Count)"

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: src/*.mind
