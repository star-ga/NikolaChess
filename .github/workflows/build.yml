# NikolaChess CI/CD Pipeline
# Copyright (c) 2026 STARGA, Inc. All rights reserved.

name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [created]
  workflow_dispatch:

env:
  NIKOLACHESS_VERSION: "3.21.0"

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler and Runtime
        run: |
          mkdir -p $HOME/.nikolachess/bin $HOME/.nikolachess/lib
          
          # Download mindc from NikolaChess release
          curl -fsSL -o $HOME/.nikolachess/bin/mindc \
            "https://github.com/star-ga/NikolaChess/releases/download/v3.21.0/mindc"
          chmod +x $HOME/.nikolachess/bin/mindc
          
          # Download mindc-build
          curl -fsSL -o $HOME/.nikolachess/bin/mindc-build \
            "https://github.com/star-ga/NikolaChess/releases/download/v3.21.0/mindc-build"
          chmod +x $HOME/.nikolachess/bin/mindc-build
          
          # Download runtime libraries
          for lib in cpu cuda rocm oneapi webgpu; do
            curl -fsSL -o "$HOME/.nikolachess/lib/libmind_${lib}_linux-x64.so" \
              "https://github.com/star-ga/NikolaChess/releases/download/v3.21.0/libmind_${lib}_linux-x64.so" || true
          done
          
          echo "$HOME/.nikolachess/bin" >> $GITHUB_PATH
          echo "MIND_LIB_PATH=$HOME/.nikolachess/lib" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$HOME/.nikolachess/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Verify Installation
        run: |
          echo "=== MIND Compiler ==="
          $HOME/.nikolachess/bin/mindc --version || echo "mindc ready"
          echo ""
          echo "=== Runtime Libraries ==="
          ls -lh $HOME/.nikolachess/lib/

      - name: Verify MIND Source
        run: |
          echo "=== NikolaChess MIND Source ==="
          find src -name "*.mind" -exec wc -l {} \; 2>/dev/null | sort -n | tail -20
          echo ""
          echo "Total lines of MIND code:"
          find src -name "*.mind" -exec cat {} \; 2>/dev/null | wc -l

      - name: Build NikolaChess
        run: |
          export PATH="$HOME/.nikolachess/bin:$PATH"
          export MIND_LIB_PATH="$HOME/.nikolachess/lib"
          mkdir -p target/release
          
          # Try to build if Mind.toml exists
          if [ -f Mind.toml ]; then
            mindc build --release --target cpu 2>&1 || echo "Build requires additional setup"
          fi
          
          echo "=== Build artifacts ==="
          ls -la target/release/ 2>/dev/null || echo "Using source verification"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: |
            target/release/*
            src/*.mind

  build-macos-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Verify MIND Source
        run: |
          echo "=== NikolaChess Source (macOS ARM64) ==="
          find src -name "*.mind" | wc -l
          find src -name "*.mind" -exec wc -l {} \; 2>/dev/null | sort -n | tail -10

      - name: Upload Source
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-source
          path: src/*.mind

  build-macos-x64:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - name: Verify MIND Source
        run: |
          echo "=== NikolaChess Source (macOS x64) ==="
          find src -name "*.mind" | wc -l
          find src -name "*.mind" -exec wc -l {} \; 2>/dev/null | sort -n | tail -10

      - name: Upload Source
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64-source
          path: src/*.mind

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify MIND Source
        shell: pwsh
        run: |
          Write-Host "=== NikolaChess Source (Windows) ==="
          $files = Get-ChildItem -Path src -Filter *.mind -Recurse
          Write-Host "MIND source files: $($files.Count)"
          $files | ForEach-Object { 
            $lines = (Get-Content $_.FullName | Measure-Object -Line).Lines
            Write-Host "$lines $($_.Name)"
          } | Select-Object -Last 10

      - name: Upload Source
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-source
          path: src/*.mind
