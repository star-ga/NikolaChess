# NikolaChess CI/CD Pipeline
# Copyright (c) 2026 STARGA, Inc. All rights reserved.

name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  release:
    types: [created]
  workflow_dispatch:

env:
  NIKOLACHESS_VERSION: "0.1.0"

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install NikolaChess (MIND Compiler + Runtime)
        run: |
          curl -fsSL https://nikolachess.com/install.sh | bash
          echo "$HOME/.nikolachess/bin" >> $GITHUB_PATH
          echo "MIND_LIB_PATH=$HOME/.nikolachess/lib" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=$HOME/.nikolachess/lib:$LD_LIBRARY_PATH" >> $GITHUB_ENV

      - name: Verify Installation
        run: |
          export PATH="$HOME/.nikolachess/bin:$PATH"
          mindc --version
          mindc-build --help | head -5
          ls -la $HOME/.nikolachess/lib/

      - name: Build CPU Version
        run: |
          export PATH="$HOME/.nikolachess/bin:$PATH"
          export MIND_LIB_PATH="$HOME/.nikolachess/lib"
          make release

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-cpu
          path: target/release/nikola-cpu

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install NikolaChess (MIND Compiler + Runtime)
        run: |
          curl -fsSL https://nikolachess.com/install.sh | bash
          echo "$HOME/.nikolachess/bin" >> $GITHUB_PATH
          echo "MIND_LIB_PATH=$HOME/.nikolachess/lib" >> $GITHUB_ENV

      - name: Verify Installation
        run: |
          export PATH="$HOME/.nikolachess/bin:$PATH"
          mindc --version
          mindc-build --help | head -5
          ls -la $HOME/.nikolachess/lib/

      - name: Build CPU Version
        run: |
          export PATH="$HOME/.nikolachess/bin:$PATH"
          export MIND_LIB_PATH="$HOME/.nikolachess/lib"
          make release

      - name: Upload macOS ARM64 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-cpu
          path: target/release/nikola-cpu

  build-macos-x64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install NikolaChess (MIND Compiler + Runtime)
        run: |
          curl -fsSL https://nikolachess.com/install.sh | bash
          echo "$HOME/.nikolachess/bin" >> $GITHUB_PATH
          echo "MIND_LIB_PATH=$HOME/.nikolachess/lib" >> $GITHUB_ENV

      - name: Verify Installation
        run: |
          export PATH="$HOME/.nikolachess/bin:$PATH"
          mindc --version
          mindc-build --help | head -5
          ls -la $HOME/.nikolachess/lib/

      - name: Build CPU Version
        run: |
          export PATH="$HOME/.nikolachess/bin:$PATH"
          export MIND_LIB_PATH="$HOME/.nikolachess/lib"
          make release

      - name: Upload macOS x64 Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64-cpu
          path: target/release/nikola-cpu

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install NikolaChess (MIND Compiler + Runtime)
        shell: pwsh
        run: |
          irm https://nikolachess.com/install.ps1 | iex
          echo "$env:USERPROFILE\.nikolachess\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "MIND_LIB_PATH=$env:USERPROFILE\.nikolachess\lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Verify Installation
        shell: bash
        run: |
          export PATH="$USERPROFILE/.nikolachess/bin:$PATH"
          mindc --version || true
          mindc-build --help 2>/dev/null | head -5 || true
          ls -la "$USERPROFILE/.nikolachess/lib/" || true

      - name: Build CPU Version
        shell: bash
        run: |
          export PATH="$USERPROFILE/.nikolachess/bin:$PATH"
          export MIND_LIB_PATH="$USERPROFILE/.nikolachess/lib"
          # Run mindc-build directly (make can invoke via WSL on Windows)
          bash "$USERPROFILE/.nikolachess/bin/mindc-build" --release --verbose

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-cpu
          path: target/release/nikola-cpu.exe
