# NikolaChess Release Workflow
# Copyright (c) 2026 STARGA, Inc. All rights reserved.
# Builds FULL protected runtime libraries with protection.mind on ALL platforms

name: Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 3.21.0)'
        required: true
        type: string

permissions:
  contents: write

env:
  NIKOLACHESS_VERSION: "3.21.0"
  MIND_VERSION: "0.1.9"

jobs:
  # ==========================================================================
  # Build FULL Protected Runtime Libraries with protection.mind
  # ==========================================================================
  build-protected:
    name: Build ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux x64
            platform: linux-x64
            ext: so
            prefix: lib
            backends: "cpu cuda rocm oneapi webgpu"
            mindc_archive: tar.gz
          - os: ubuntu-24.04-arm
            name: Linux ARM64
            platform: linux-arm64
            ext: so
            prefix: lib
            backends: "cpu cuda rocm oneapi webgpu"
            mindc_archive: tar.gz
          - os: macos-14
            name: macOS ARM64
            platform: macos-arm64
            ext: dylib
            prefix: lib
            backends: "cpu metal webgpu"
            mindc_archive: tar.gz
          - os: macos-15
            name: macOS x64
            platform: macos-x64
            ext: dylib
            prefix: lib
            backends: "cpu metal webgpu"
            mindc_archive: tar.gz
          - os: windows-latest
            name: Windows x64
            platform: windows-x64
            ext: dll
            prefix: ""
            backends: "cpu cuda directx oneapi rocm webgpu"
            mindc_archive: zip

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download MLIR Tools (Linux)
        if: runner.os == 'Linux'
        run: |
          # Download pre-built MLIR tools from star-ga/mlir-tools
          echo "=== Downloading MLIR Tools from star-ga/mlir-tools ==="
          MLIR_VERSION="llvmorg-21.1.8"
          ARCHIVE="mlir-${{ matrix.platform }}.tar.gz"

          mkdir -p $HOME/.mlir-tools
          curl -fsSL "https://github.com/star-ga/mlir-tools/releases/download/${MLIR_VERSION}/${ARCHIVE}" \
            -o /tmp/mlir-tools.tar.gz || {
              echo "Pre-built MLIR tools not available, falling back to system packages..."
              sudo apt-get update
              sudo apt-get install -y mlir-18-tools clang-18
              echo "/usr/lib/llvm-18/bin" >> $GITHUB_PATH
              exit 0
            }

          tar -xzf /tmp/mlir-tools.tar.gz -C $HOME/.mlir-tools
          echo "$HOME/.mlir-tools/bin" >> $GITHUB_PATH

          echo "mlir-opt: $(which mlir-opt 2>/dev/null || echo 'will be in PATH after this step')"

      - name: Download MLIR Tools (macOS)
        if: runner.os == 'macOS'
        run: |
          # Download pre-built MLIR tools from star-ga/mlir-tools
          echo "=== Downloading MLIR Tools from star-ga/mlir-tools ==="
          MLIR_VERSION="llvmorg-21.1.8"
          ARCHIVE="mlir-${{ matrix.platform }}.tar.gz"

          mkdir -p $HOME/.mlir-tools
          curl -fsSL "https://github.com/star-ga/mlir-tools/releases/download/${MLIR_VERSION}/${ARCHIVE}" \
            -o /tmp/mlir-tools.tar.gz || {
              echo "Pre-built MLIR tools not available, falling back to brew..."
              brew install llvm@18
              LLVM_PREFIX=$(brew --prefix llvm@18)
              echo "${LLVM_PREFIX}/bin" >> $GITHUB_PATH
              exit 0
            }

          tar -xzf /tmp/mlir-tools.tar.gz -C $HOME/.mlir-tools
          echo "$HOME/.mlir-tools/bin" >> $GITHUB_PATH

      - name: Download MLIR Tools (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Download pre-built MLIR tools from star-ga/mlir-tools
          Write-Host "=== Downloading MLIR Tools from star-ga/mlir-tools ==="
          $mlirVersion = "llvmorg-21.1.8"
          $archive = "mlir-${{ matrix.platform }}.zip"

          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.mlir-tools" | Out-Null

          try {
            Invoke-WebRequest -Uri "https://github.com/star-ga/mlir-tools/releases/download/${mlirVersion}/${archive}" `
              -OutFile "$env:TEMP\mlir-tools.zip"
            Expand-Archive -Path "$env:TEMP\mlir-tools.zip" -DestinationPath "$env:USERPROFILE\.mlir-tools" -Force
            echo "$env:USERPROFILE\.mlir-tools\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } catch {
            Write-Host "Pre-built MLIR tools not available, using system LLVM..."
            echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }

      - name: Clone Runtime Source
        run: |
          git clone --depth 1 https://${{ secrets.RUNTIME_TOKEN }}@github.com/star-ga/nikolachess-source.git runtime-src
        env:
          RUNTIME_TOKEN: ${{ secrets.RUNTIME_TOKEN }}

      - name: Build MIND Compiler with mlir-build (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "=== Building mindc with mlir-build feature ==="
          git clone --depth 1 https://github.com/star-ga/mind.git /tmp/mind-compiler
          cd /tmp/mind-compiler

          # Build with all required features for --emit-obj support
          cargo build --release --features mlir-build,mlir-lowering,autodiff

          mkdir -p $HOME/.mind/bin
          cp target/release/mindc $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

          echo "=== mindc built with mlir-build ==="
          $HOME/.mind/bin/mindc --version

      - name: Build MIND Compiler with mlir-build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== Building mindc with mlir-build feature ==="
          git clone --depth 1 https://github.com/star-ga/mind.git $env:TEMP\mind-compiler
          Set-Location $env:TEMP\mind-compiler

          # Build with all required features for --emit-obj support
          cargo build --release --features mlir-build,mlir-lowering,autodiff

          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.mind\bin"
          Copy-Item target\release\mindc.exe "$env:USERPROFILE\.mind\bin\"
          echo "$env:USERPROFILE\.mind\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

          Write-Host "=== mindc built with mlir-build ==="
          & "$env:USERPROFILE\.mind\bin\mindc.exe" --version

      - name: Build FULL Protected Libraries (Unix) - 100% Pure MIND
        if: runner.os != 'Windows'
        run: |
          mkdir -p output
          cd runtime-src/runtime-build

          echo "=== Compiling FULL Protected Pure MIND Libraries ==="
          echo "Using mindc build with Mind.toml project configuration"

          # Verify tools are in PATH
          echo "mindc: $(which mindc)"
          echo "mlir-opt: $(which mlir-opt 2>/dev/null || echo 'not found')"
          echo "mlir-translate: $(which mlir-translate 2>/dev/null || echo 'not found')"
          echo "clang: $(which clang 2>/dev/null || echo 'not found')"

          # Build each backend using mindc build --target
          for backend in ${{ matrix.backends }}; do
            out_name="${{ matrix.prefix }}mind_${backend}_${{ matrix.platform }}.${{ matrix.ext }}"

            echo ""
            echo "=== Building ${out_name} (target: ${backend}) ==="

            # Build using Mind.toml configuration
            mindc build --release --target "${backend}" --verbose 2>&1 || {
              echo "⚠ Build failed for ${backend}, checking for pre-built fallback..."
              if [ -f "${out_name}" ]; then
                cp "${out_name}" "../../output/${out_name}"
                size=$(ls -lh "../../output/${out_name}" | awk '{print $5}')
                echo "✓ Using pre-built: ${out_name} (${size})"
                continue
              else
                echo "⚠ No pre-built available for ${backend}"
                continue
              fi
            }

            # Find and copy the built library
            built_lib=$(find . -name "*mind_${backend}*.${{ matrix.ext }}" -newer Mind.toml 2>/dev/null | head -1)
            if [ -n "$built_lib" ]; then
              cp "$built_lib" "../../output/${out_name}"
              size=$(ls -lh "../../output/${out_name}" | awk '{print $5}')
              echo "✓ Built FULL protected: ${out_name} (${size})"
            elif [ -f "${out_name}" ]; then
              # Fallback to pre-built
              cp "${out_name}" "../../output/${out_name}"
              size=$(ls -lh "../../output/${out_name}" | awk '{print $5}')
              echo "✓ Using pre-built: ${out_name} (${size})"
            fi
          done

          cd ../..
          echo ""
          echo "=== FULL Protected Libraries ==="
          ls -lh output/ || echo "No libraries in output"

          # Verify at least one library was built
          if [ ! "$(ls -A output/)" ]; then
            echo "ERROR: No protected libraries found"
            exit 1
          fi

      - name: Build FULL Protected Libraries (Windows) - 100% Pure MIND
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path output
          Set-Location runtime-src\runtime-build

          Write-Host "=== Compiling FULL Protected Pure MIND Libraries ==="
          Write-Host "Using mindc build with Mind.toml project configuration"

          # Verify tools are in PATH
          Write-Host "mindc: $(Get-Command mindc -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Source)"
          Write-Host "mlir-opt: $(Get-Command mlir-opt -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Source)"
          Write-Host "clang: $(Get-Command clang -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Source)"

          # Build each backend using mindc build --target
          $backends = "${{ matrix.backends }}".Split(" ")
          foreach ($backend in $backends) {
            $outName = "mind_${backend}_${{ matrix.platform }}.${{ matrix.ext }}"

            Write-Host ""
            Write-Host "=== Building $outName (target: $backend) ==="

            # Build using Mind.toml configuration
            try {
              & mindc build --release --target $backend --verbose 2>&1

              # Find and copy the built library
              $builtLib = Get-ChildItem -Recurse -Filter "*mind_${backend}*.${{ matrix.ext }}" -ErrorAction SilentlyContinue |
                          Where-Object { $_.LastWriteTime -gt (Get-Item Mind.toml).LastWriteTime } |
                          Select-Object -First 1

              if ($builtLib) {
                Copy-Item $builtLib.FullName "..\..\output\$outName"
                $size = [math]::Round((Get-Item "..\..\output\$outName").Length/1MB, 2)
                Write-Host "✓ Built FULL protected: $outName ($size MB)"
              } elseif (Test-Path $outName) {
                # Fallback to pre-built
                Copy-Item $outName "..\..\output\$outName"
                $size = [math]::Round((Get-Item "..\..\output\$outName").Length/1MB, 2)
                Write-Host "✓ Using pre-built: $outName ($size MB)"
              }
            } catch {
              Write-Host "⚠ Build failed for $backend, checking for pre-built fallback..."
              if (Test-Path $outName) {
                Copy-Item $outName "..\..\output\$outName"
                $size = [math]::Round((Get-Item "..\..\output\$outName").Length/1MB, 2)
                Write-Host "✓ Using pre-built: $outName ($size MB)"
              } else {
                Write-Host "⚠ No pre-built available for $backend"
              }
            }
          }

          Set-Location ..\..
          Write-Host ""
          Write-Host "=== FULL Protected Libraries ==="
          Get-ChildItem output\

          # Verify at least one library was built
          if (-not (Get-ChildItem output\ -ErrorAction SilentlyContinue)) {
            Write-Host "ERROR: No protected libraries found"
            exit 1
          }

      - name: Upload Libraries
        uses: actions/upload-artifact@v4
        with:
          name: runtime-${{ matrix.platform }}
          path: output/*

  # ==========================================================================
  # Verify MIND Source
  # ==========================================================================
  verify:
    name: Verify ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux x64
            platform: linux-x64
          - os: ubuntu-24.04-arm
            name: Linux ARM64
            platform: linux-arm64
          - os: macos-14
            name: macOS ARM64
            platform: macos-arm64
          - os: macos-15
            name: macOS x64
            platform: macos-x64
          - os: windows-latest
            name: Windows x64
            platform: windows-x64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-${{ matrix.platform }}.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Download MIND Compiler (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.mind\bin"
          Invoke-WebRequest -Uri "https://github.com/star-ga/mind/releases/download/v$env:MIND_VERSION/mindc-${{ matrix.platform }}.zip" -OutFile "$env:TEMP\mindc.zip"
          Expand-Archive -Path "$env:TEMP\mindc.zip" -DestinationPath "$env:USERPROFILE\.mind\bin" -Force
          echo "$env:USERPROFILE\.mind\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify Source (Unix)
        if: runner.os != 'Windows'
        run: |
          mindc --version
          mindc src/main.mind --verify-only
          echo "MIND files: $(find src -name '*.mind' | wc -l)"

      - name: Verify Source (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          & "$env:USERPROFILE\.mind\bin\mindc.exe" --version
          & "$env:USERPROFILE\.mind\bin\mindc.exe" src\main.mind --verify-only
          Write-Host "MIND files: $((Get-ChildItem -Path src -Filter *.mind -Recurse).Count)"

  # ==========================================================================
  # Upload to Release
  # ==========================================================================
  upload:
    name: Upload to Release
    needs: [build-protected, verify]
    runs-on: ubuntu-latest

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List FULL Protected Libraries
        run: |
          echo "=== FULL Protected Libraries ==="
          ls -lh artifacts/
          echo ""
          echo "Total: $(ls artifacts/ | wc -l) libraries"
          echo "Total size: $(du -sh artifacts/ | awk '{print $1}')"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NIKOLACHESS_VERSION }}
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
