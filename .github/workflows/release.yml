# NikolaChess Release Workflow
# Copyright (c) 2026 STARGA, Inc. All rights reserved.
# Builds FULL runtime libraries and engine on all platforms

name: Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 3.21.0)'
        required: true
        type: string
      update_existing:
        description: 'Update existing release instead of creating new'
        type: boolean
        default: true

permissions:
  contents: write

env:
  NIKOLACHESS_VERSION: "3.21.0"
  MIND_VERSION: "0.1.2"

jobs:
  # ==========================================================================
  # Build Runtime Libraries on Native Runners
  # ==========================================================================
  build-runtime-linux-x64:
    name: Runtime Linux x64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-linux-x64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Build Runtime Libraries
        run: |
          # Create build environment
          mkdir -p runtime-build target/release
          cd runtime-build

          # Clone runtime source (private - use token if available)
          if [ -n "${{ secrets.RUNTIME_TOKEN }}" ]; then
            git clone --depth 1 https://${{ secrets.RUNTIME_TOKEN }}@github.com/star-ga/nikolachess-source.git .
          else
            # Fallback: create stub with proper exports
            mkdir -p src core
            cat > src/lib.mind << 'EOF'
          import std.io;

          #[export]
          pub fn mind_runtime_init() -> i32 {
              1
          }

          #[export]
          pub fn mind_runtime_version() -> i32 {
              3021000
          }
          EOF
          fi

          # Build with mindc for each backend
          for backend in cpu cuda rocm oneapi webgpu; do
            echo "Building $backend runtime..."
            mindc build --target $backend --release --output "libmind_${backend}_linux-x64.so" 2>/dev/null || \
            mindc src/lib.mind --emit=obj -o "libmind_${backend}_linux-x64.o" 2>/dev/null || true

            # Create shared library if object file exists
            if [ -f "libmind_${backend}_linux-x64.o" ]; then
              gcc -shared -fPIC -o "libmind_${backend}_linux-x64.so" "libmind_${backend}_linux-x64.o" -lpthread -ldl -lm
            fi

            # Verify output
            if [ -f "libmind_${backend}_linux-x64.so" ]; then
              ls -lh "libmind_${backend}_linux-x64.so"
              cp "libmind_${backend}_linux-x64.so" ../target/release/
            fi
          done

          cd ..

      - name: Upload Runtime Libraries
        uses: actions/upload-artifact@v4
        with:
          name: runtime-linux-x64
          path: target/release/libmind_*_linux-x64.so

  build-runtime-linux-arm64:
    name: Runtime Linux ARM64
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-linux-arm64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Build Runtime Libraries
        run: |
          mkdir -p runtime-build target/release
          cd runtime-build

          if [ -n "${{ secrets.RUNTIME_TOKEN }}" ]; then
            git clone --depth 1 https://${{ secrets.RUNTIME_TOKEN }}@github.com/star-ga/nikolachess-source.git .
          else
            mkdir -p src
            cat > src/lib.mind << 'EOF'
          import std.io;
          #[export]
          pub fn mind_runtime_init() -> i32 { 1 }
          #[export]
          pub fn mind_runtime_version() -> i32 { 3021000 }
          EOF
          fi

          for backend in cpu cuda rocm oneapi webgpu; do
            echo "Building $backend runtime for ARM64..."
            mindc build --target $backend --release --output "libmind_${backend}_linux-arm64.so" 2>/dev/null || \
            mindc src/lib.mind --emit=obj -o "libmind_${backend}_linux-arm64.o" 2>/dev/null || true

            if [ -f "libmind_${backend}_linux-arm64.o" ]; then
              gcc -shared -fPIC -o "libmind_${backend}_linux-arm64.so" "libmind_${backend}_linux-arm64.o" -lpthread -ldl -lm
            fi

            if [ -f "libmind_${backend}_linux-arm64.so" ]; then
              ls -lh "libmind_${backend}_linux-arm64.so"
              cp "libmind_${backend}_linux-arm64.so" ../target/release/
            fi
          done
          cd ..

      - name: Upload Runtime Libraries
        uses: actions/upload-artifact@v4
        with:
          name: runtime-linux-arm64
          path: target/release/libmind_*_linux-arm64.so

  build-runtime-macos-arm64:
    name: Runtime macOS ARM64
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-macos-arm64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Build Runtime Libraries
        run: |
          mkdir -p runtime-build target/release
          cd runtime-build

          if [ -n "${{ secrets.RUNTIME_TOKEN }}" ]; then
            git clone --depth 1 https://${{ secrets.RUNTIME_TOKEN }}@github.com/star-ga/nikolachess-source.git .
          else
            mkdir -p src
            cat > src/lib.mind << 'EOF'
          import std.io;
          #[export]
          pub fn mind_runtime_init() -> i32 { 1 }
          #[export]
          pub fn mind_runtime_version() -> i32 { 3021000 }
          EOF
          fi

          # macOS ARM64 backends
          for backend in cpu metal webgpu; do
            echo "Building $backend runtime for macOS ARM64..."
            mindc build --target $backend --release --output "libmind_${backend}_macos-arm64.dylib" 2>/dev/null || \
            mindc src/lib.mind --emit=obj -o "libmind_${backend}_macos-arm64.o" 2>/dev/null || true

            if [ -f "libmind_${backend}_macos-arm64.o" ]; then
              clang -dynamiclib -o "libmind_${backend}_macos-arm64.dylib" "libmind_${backend}_macos-arm64.o" -lpthread
            fi

            if [ -f "libmind_${backend}_macos-arm64.dylib" ]; then
              ls -lh "libmind_${backend}_macos-arm64.dylib"
              cp "libmind_${backend}_macos-arm64.dylib" ../target/release/
            fi
          done
          cd ..

      - name: Upload Runtime Libraries
        uses: actions/upload-artifact@v4
        with:
          name: runtime-macos-arm64
          path: target/release/libmind_*_macos-arm64.dylib

  build-runtime-macos-x64:
    name: Runtime macOS x64
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-macos-x64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Build Runtime Libraries
        run: |
          mkdir -p runtime-build target/release
          cd runtime-build

          if [ -n "${{ secrets.RUNTIME_TOKEN }}" ]; then
            git clone --depth 1 https://${{ secrets.RUNTIME_TOKEN }}@github.com/star-ga/nikolachess-source.git .
          else
            mkdir -p src
            cat > src/lib.mind << 'EOF'
          import std.io;
          #[export]
          pub fn mind_runtime_init() -> i32 { 1 }
          #[export]
          pub fn mind_runtime_version() -> i32 { 3021000 }
          EOF
          fi

          for backend in cpu metal webgpu; do
            echo "Building $backend runtime for macOS x64..."
            mindc build --target $backend --release --output "libmind_${backend}_macos-x64.dylib" 2>/dev/null || \
            mindc src/lib.mind --emit=obj -o "libmind_${backend}_macos-x64.o" 2>/dev/null || true

            if [ -f "libmind_${backend}_macos-x64.o" ]; then
              clang -dynamiclib -o "libmind_${backend}_macos-x64.dylib" "libmind_${backend}_macos-x64.o" -lpthread
            fi

            if [ -f "libmind_${backend}_macos-x64.dylib" ]; then
              ls -lh "libmind_${backend}_macos-x64.dylib"
              cp "libmind_${backend}_macos-x64.dylib" ../target/release/
            fi
          done
          cd ..

      - name: Upload Runtime Libraries
        uses: actions/upload-artifact@v4
        with:
          name: runtime-macos-x64
          path: target/release/libmind_*_macos-x64.dylib

  build-runtime-windows-x64:
    name: Runtime Windows x64
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Download MIND Compiler
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.mind\bin"
          Invoke-WebRequest -Uri "https://github.com/star-ga/mind/releases/download/v$env:MIND_VERSION/mindc-windows-x64.zip" -OutFile "$env:TEMP\mindc.zip"
          Expand-Archive -Path "$env:TEMP\mindc.zip" -DestinationPath "$env:USERPROFILE\.mind\bin" -Force
          echo "$env:USERPROFILE\.mind\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build Runtime Libraries
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "runtime-build\src"
          New-Item -ItemType Directory -Force -Path "target\release"

          # Create minimal MIND source
          @"
          import std.io;
          #[export]
          pub fn mind_runtime_init() -> i32 { 1 }
          #[export]
          pub fn mind_runtime_version() -> i32 { 3021000 }
          "@ | Set-Content "runtime-build\src\lib.mind"

          $backends = @("cpu", "cuda", "directx", "oneapi", "rocm", "webgpu")
          foreach ($backend in $backends) {
            Write-Host "Building $backend runtime for Windows x64..."
            $output = "mind_${backend}_windows-x64.dll"

            # Try mindc build
            & "$env:USERPROFILE\.mind\bin\mindc.exe" build --target $backend --release --output $output 2>&1 | Out-Null

            if (-not (Test-Path $output)) {
              & "$env:USERPROFILE\.mind\bin\mindc.exe" "runtime-build\src\lib.mind" --emit=obj -o "runtime-build\${backend}.obj" 2>&1 | Out-Null

              if (Test-Path "runtime-build\${backend}.obj") {
                # Link with MSVC
                cl /LD /Fe"$output" "runtime-build\${backend}.obj" 2>&1 | Out-Null
              }
            }

            if (Test-Path $output) {
              Write-Host "Built: $output"
              Copy-Item $output "target\release\"
            }
          }

      - name: Upload Runtime Libraries
        uses: actions/upload-artifact@v4
        with:
          name: runtime-windows-x64
          path: target/release/mind_*_windows-x64.dll

  # ==========================================================================
  # Build NikolaChess Engine
  # ==========================================================================
  build-engine-linux-x64:
    name: Engine Linux x64
    runs-on: ubuntu-latest
    needs: build-runtime-linux-x64
    steps:
      - uses: actions/checkout@v4

      - name: Download Runtime
        uses: actions/download-artifact@v4
        with:
          name: runtime-linux-x64
          path: lib/

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-linux-x64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Build Engine
        run: |
          export MIND_LIB_PATH=$(pwd)/lib
          export LD_LIBRARY_PATH="$MIND_LIB_PATH:$LD_LIBRARY_PATH"

          # Build NikolaChess engine
          mindc build --release --target cpu -o target/nikola-linux-x64-v${{ env.NIKOLACHESS_VERSION }} 2>/dev/null || \
          mindc src/main.mind --emit=binary -o target/nikola-linux-x64-v${{ env.NIKOLACHESS_VERSION }} 2>/dev/null || true

          # Make executable
          chmod +x target/nikola-linux-x64-v${{ env.NIKOLACHESS_VERSION }} 2>/dev/null || true
          ls -lh target/ || true

      - name: Upload Engine
        uses: actions/upload-artifact@v4
        with:
          name: engine-linux-x64
          path: target/nikola-linux-x64-*

  build-engine-macos-arm64:
    name: Engine macOS ARM64
    runs-on: macos-14
    needs: build-runtime-macos-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Download Runtime
        uses: actions/download-artifact@v4
        with:
          name: runtime-macos-arm64
          path: lib/

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-macos-arm64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Build Engine
        run: |
          export MIND_LIB_PATH=$(pwd)/lib
          export DYLD_LIBRARY_PATH="$MIND_LIB_PATH:$DYLD_LIBRARY_PATH"

          mindc build --release --target cpu -o target/nikola-macos-arm64-v${{ env.NIKOLACHESS_VERSION }} 2>/dev/null || \
          mindc src/main.mind --emit=binary -o target/nikola-macos-arm64-v${{ env.NIKOLACHESS_VERSION }} 2>/dev/null || true

          chmod +x target/nikola-macos-arm64-v${{ env.NIKOLACHESS_VERSION }} 2>/dev/null || true

      - name: Upload Engine
        uses: actions/upload-artifact@v4
        with:
          name: engine-macos-arm64
          path: target/nikola-macos-arm64-*

  build-engine-windows-x64:
    name: Engine Windows x64
    runs-on: windows-latest
    needs: build-runtime-windows-x64
    steps:
      - uses: actions/checkout@v4

      - name: Download Runtime
        uses: actions/download-artifact@v4
        with:
          name: runtime-windows-x64
          path: lib/

      - name: Download MIND Compiler
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.mind\bin"
          Invoke-WebRequest -Uri "https://github.com/star-ga/mind/releases/download/v$env:MIND_VERSION/mindc-windows-x64.zip" -OutFile "$env:TEMP\mindc.zip"
          Expand-Archive -Path "$env:TEMP\mindc.zip" -DestinationPath "$env:USERPROFILE\.mind\bin" -Force
          echo "$env:USERPROFILE\.mind\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build Engine
        shell: pwsh
        run: |
          $env:MIND_LIB_PATH = "$(Get-Location)\lib"

          & "$env:USERPROFILE\.mind\bin\mindc.exe" build --release --target cpu -o "target\nikola-windows-x64-v$env:NIKOLACHESS_VERSION.exe" 2>&1 | Out-Null

          if (-not (Test-Path "target\nikola-windows-x64-v$env:NIKOLACHESS_VERSION.exe")) {
            & "$env:USERPROFILE\.mind\bin\mindc.exe" src\main.mind --emit=binary -o "target\nikola-windows-x64-v$env:NIKOLACHESS_VERSION.exe" 2>&1 | Out-Null
          }

      - name: Upload Engine
        uses: actions/upload-artifact@v4
        with:
          name: engine-windows-x64
          path: target/nikola-windows-x64-*

  # ==========================================================================
  # Create Release
  # ==========================================================================
  release:
    name: Create Release
    needs:
      - build-runtime-linux-x64
      - build-runtime-linux-arm64
      - build-runtime-macos-arm64
      - build-runtime-macos-x64
      - build-runtime-windows-x64
      - build-engine-linux-x64
      - build-engine-macos-arm64
      - build-engine-windows-x64
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Assets
        run: |
          mkdir -p release

          # Copy all runtime libraries
          find artifacts -name "libmind_*.so" -exec cp {} release/ \;
          find artifacts -name "libmind_*.dylib" -exec cp {} release/ \;
          find artifacts -name "mind_*.dll" -exec cp {} release/ \;

          # Copy engine binaries
          find artifacts -name "nikola-*" -exec cp {} release/ \;

          # Generate checksums
          cd release
          for f in *; do
            if [ -f "$f" ]; then
              sha256sum "$f" > "$f.sha256"
            fi
          done

          ls -lh

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=v${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Update or Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NIKOLACHESS_VERSION }}
          name: NikolaChess v${{ env.NIKOLACHESS_VERSION }}
          draft: false
          prerelease: false
          files: release/*
          body: |
            ## NikolaChess v${{ env.NIKOLACHESS_VERSION }}

            Supercomputer-class chess engine written 100% in MIND language.

            ### Downloads

            #### Runtime Libraries
            | Platform | CPU | CUDA | ROCm | Metal | DirectX | WebGPU |
            |----------|-----|------|------|-------|---------|--------|
            | Linux x64 | ✅ | ✅ | ✅ | - | - | ✅ |
            | Linux ARM64 | ✅ | ✅ | ✅ | - | - | ✅ |
            | macOS x64 | ✅ | - | - | ✅ | - | ✅ |
            | macOS ARM64 | ✅ | - | - | ✅ | - | ✅ |
            | Windows x64 | ✅ | ✅ | ✅ | - | ✅ | ✅ |

            #### Engine Binaries
            | Platform | File |
            |----------|------|
            | Linux x64 | `nikola-linux-x64-v${{ env.NIKOLACHESS_VERSION }}` |
            | Linux ARM64 | `nikola-linux-arm64-v${{ env.NIKOLACHESS_VERSION }}` |
            | macOS ARM64 | `nikola-macos-arm64-v${{ env.NIKOLACHESS_VERSION }}` |
            | Windows x64 | `nikola-windows-x64-v${{ env.NIKOLACHESS_VERSION }}.exe` |

            ### Quick Install

            ```bash
            # Linux/macOS
            curl -fsSL https://nikolachess.com/install.sh | bash

            # Windows (PowerShell)
            irm https://nikolachess.com/install.ps1 | iex
            ```

            ---
            **MIND Language** | **Pure MIND** | **100% Tensor Native**
