# NikolaChess Release Workflow
# Copyright (c) 2026 STARGA, Inc. All rights reserved.
# Verifies MIND source and prepares release assets

name: Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 3.21.0)'
        required: true
        type: string

permissions:
  contents: write

env:
  NIKOLACHESS_VERSION: "3.21.0"
  MIND_VERSION: "0.1.2"

jobs:
  # ==========================================================================
  # Verify MIND Source on All Platforms
  # ==========================================================================
  verify:
    name: Verify ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux x64
            platform: linux-x64
          - os: ubuntu-24.04-arm
            name: Linux ARM64
            platform: linux-arm64
          - os: macos-14
            name: macOS ARM64
            platform: macos-arm64
          - os: macos-15
            name: macOS x64
            platform: macos-x64
          - os: windows-latest
            name: Windows x64
            platform: windows-x64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-${{ matrix.platform }}.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Download MIND Compiler (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.mind\bin"
          Invoke-WebRequest -Uri "https://github.com/star-ga/mind/releases/download/v$env:MIND_VERSION/mindc-${{ matrix.platform }}.zip" -OutFile "$env:TEMP\mindc.zip"
          Expand-Archive -Path "$env:TEMP\mindc.zip" -DestinationPath "$env:USERPROFILE\.mind\bin" -Force
          echo "$env:USERPROFILE\.mind\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify MIND Source (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "=== MIND Compiler ==="
          mindc --version
          echo ""
          echo "=== Verifying NikolaChess Source ==="
          mindc src/main.mind --verify-only
          echo ""
          echo "=== Source Statistics ==="
          echo "MIND files: $(find src -name '*.mind' | wc -l)"
          echo "Total lines: $(find src -name '*.mind' -exec cat {} \; | wc -l)"

      - name: Verify MIND Source (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "=== MIND Compiler ==="
          & "$env:USERPROFILE\.mind\bin\mindc.exe" --version
          Write-Host ""
          Write-Host "=== Verifying NikolaChess Source ==="
          & "$env:USERPROFILE\.mind\bin\mindc.exe" src\main.mind --verify-only
          Write-Host ""
          Write-Host "=== Source Statistics ==="
          $files = (Get-ChildItem -Path src -Filter *.mind -Recurse)
          Write-Host "MIND files: $($files.Count)"
