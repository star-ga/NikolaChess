# NikolaChess Release Workflow
# Copyright (c) 2026 STARGA, Inc. All rights reserved.
# Builds FULL protected runtime libraries with protection.mind on ALL platforms

name: Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 3.21.0)'
        required: true
        type: string

permissions:
  contents: write

env:
  NIKOLACHESS_VERSION: "3.21.0"
  MIND_VERSION: "0.1.3"

jobs:
  # ==========================================================================
  # Build FULL Protected Runtime Libraries with protection.mind
  # ==========================================================================
  build-protected:
    name: Build ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux x64
            platform: linux-x64
            ext: so
            prefix: lib
            backends: "cpu cuda rocm oneapi webgpu"
            mindc_archive: tar.gz
          - os: ubuntu-24.04-arm
            name: Linux ARM64
            platform: linux-arm64
            ext: so
            prefix: lib
            backends: "cpu cuda rocm oneapi webgpu"
            mindc_archive: tar.gz
          - os: macos-14
            name: macOS ARM64
            platform: macos-arm64
            ext: dylib
            prefix: lib
            backends: "cpu metal webgpu"
            mindc_archive: tar.gz
          - os: macos-15
            name: macOS x64
            platform: macos-x64
            ext: dylib
            prefix: lib
            backends: "cpu metal webgpu"
            mindc_archive: tar.gz
          - os: windows-latest
            name: Windows x64
            platform: windows-x64
            ext: dll
            prefix: ""
            backends: "cpu cuda directx oneapi rocm webgpu"
            mindc_archive: zip

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Clone Runtime Source
        run: |
          git clone --depth 1 https://${{ secrets.RUNTIME_TOKEN }}@github.com/star-ga/nikolachess-source.git runtime-src
        env:
          RUNTIME_TOKEN: ${{ secrets.RUNTIME_TOKEN }}

      - name: Download MIND Compiler (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.${{ matrix.mindc_archive }} \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-${{ matrix.platform }}.${{ matrix.mindc_archive }}"
          tar -xzf /tmp/mindc.${{ matrix.mindc_archive }} -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc*
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Download MIND Compiler (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.mind\bin"
          Invoke-WebRequest -Uri "https://github.com/star-ga/mind/releases/download/v$env:MIND_VERSION/mindc-${{ matrix.platform }}.zip" -OutFile "$env:TEMP\mindc.zip"
          Expand-Archive -Path "$env:TEMP\mindc.zip" -DestinationPath "$env:USERPROFILE\.mind\bin" -Force
          echo "$env:USERPROFILE\.mind\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Build FULL Protected Libraries (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p output
          cd runtime-src

          echo "=== Compiling protection.mind ==="
          mindc --version

          # Compile protection.mind to object file
          mindc src/protection.mind --emit-obj protection.o || {
            echo "mindc --emit-obj not ready yet, using pre-built protection"
            # Fallback: copy from runtime-build if available
            if [ -d "runtime-build" ]; then
              for backend in ${{ matrix.backends }}; do
                src="runtime-build/${{ matrix.prefix }}mind_${backend}_${{ matrix.platform }}.${{ matrix.ext }}"
                if [ -f "$src" ]; then
                  cp "$src" "../output/"
                  echo "Copied pre-built: ${{ matrix.prefix }}mind_${backend}_${{ matrix.platform }}.${{ matrix.ext }}"
                fi
              done
            fi
            exit 0
          }

          echo "=== Building Rust runtime with protection ==="
          cd runtime-rust

          # Link protection.o into the build
          export RUSTFLAGS="-C link-arg=../protection.o"
          cargo build --release

          # Get library name
          if [ "${{ runner.os }}" = "macOS" ]; then
            LIB_NAME="libmind_runtime.dylib"
          else
            LIB_NAME="libmind_runtime.so"
          fi

          # Copy for each backend
          for backend in ${{ matrix.backends }}; do
            output_name="${{ matrix.prefix }}mind_${backend}_${{ matrix.platform }}.${{ matrix.ext }}"
            if [ -f "target/release/$LIB_NAME" ]; then
              cp "target/release/$LIB_NAME" "../../output/${output_name}"
              size=$(ls -lh "../../output/${output_name}" | awk '{print $5}')
              echo "Built FULL: ${output_name} (${size})"
            fi
          done

          cd ../..
          echo ""
          echo "=== Output ==="
          ls -lh output/

      - name: Build FULL Protected Libraries (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path output
          Set-Location runtime-src

          Write-Host "=== Compiling protection.mind ==="
          & "$env:USERPROFILE\.mind\bin\mindc.exe" --version

          # Try to compile protection.mind
          $emitResult = & "$env:USERPROFILE\.mind\bin\mindc.exe" src\protection.mind --emit-obj protection.obj 2>&1
          if ($LASTEXITCODE -ne 0) {
            Write-Host "mindc --emit-obj not ready yet, using pre-built protection"
            # Fallback: copy from runtime-build
            $backends = "${{ matrix.backends }}".Split(" ")
            foreach ($backend in $backends) {
              $src = "runtime-build\mind_${backend}_${{ matrix.platform }}.${{ matrix.ext }}"
              if (Test-Path $src) {
                Copy-Item $src "..\output\"
                Write-Host "Copied pre-built: mind_${backend}_${{ matrix.platform }}.${{ matrix.ext }}"
              }
            }
            exit 0
          }

          Write-Host "=== Building Rust runtime with protection ==="
          Set-Location runtime-rust

          # Link protection.obj into the build
          $env:RUSTFLAGS = "-C link-arg=..\protection.obj"
          cargo build --release

          # Copy for each backend
          $backends = "${{ matrix.backends }}".Split(" ")
          foreach ($backend in $backends) {
            $output = "mind_${backend}_${{ matrix.platform }}.${{ matrix.ext }}"
            $source = "target\release\mind_runtime.dll"
            if (Test-Path $source) {
              Copy-Item $source "..\..\output\$output"
              $size = (Get-Item "..\..\output\$output").Length
              Write-Host "Built FULL: $output ($([math]::Round($size/1MB, 2)) MB)"
            }
          }

          Set-Location ..\..
          Write-Host ""
          Write-Host "=== Output ==="
          Get-ChildItem output\

      - name: Upload Libraries
        uses: actions/upload-artifact@v4
        with:
          name: runtime-${{ matrix.platform }}
          path: output/*

  # ==========================================================================
  # Verify MIND Source
  # ==========================================================================
  verify:
    name: Verify ${{ matrix.name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux x64
            platform: linux-x64
          - os: ubuntu-24.04-arm
            name: Linux ARM64
            platform: linux-arm64
          - os: macos-14
            name: macOS ARM64
            platform: macos-arm64
          - os: macos-15
            name: macOS x64
            platform: macos-x64
          - os: windows-latest
            name: Windows x64
            platform: windows-x64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-${{ matrix.platform }}.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Download MIND Compiler (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.mind\bin"
          Invoke-WebRequest -Uri "https://github.com/star-ga/mind/releases/download/v$env:MIND_VERSION/mindc-${{ matrix.platform }}.zip" -OutFile "$env:TEMP\mindc.zip"
          Expand-Archive -Path "$env:TEMP\mindc.zip" -DestinationPath "$env:USERPROFILE\.mind\bin" -Force
          echo "$env:USERPROFILE\.mind\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify Source (Unix)
        if: runner.os != 'Windows'
        run: |
          mindc --version
          mindc src/main.mind --verify-only
          echo "MIND files: $(find src -name '*.mind' | wc -l)"

      - name: Verify Source (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          & "$env:USERPROFILE\.mind\bin\mindc.exe" --version
          & "$env:USERPROFILE\.mind\bin\mindc.exe" src\main.mind --verify-only
          Write-Host "MIND files: $((Get-ChildItem -Path src -Filter *.mind -Recurse).Count)"

  # ==========================================================================
  # Upload to Release
  # ==========================================================================
  upload:
    name: Upload to Release
    needs: [build-protected, verify]
    runs-on: ubuntu-latest

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List FULL Protected Libraries
        run: |
          echo "=== FULL Protected Libraries ==="
          ls -lh artifacts/
          echo ""
          echo "Total: $(ls artifacts/ | wc -l) libraries"
          echo "Total size: $(du -sh artifacts/ | awk '{print $1}')"

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NIKOLACHESS_VERSION }}
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
