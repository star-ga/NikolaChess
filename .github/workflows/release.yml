# NikolaChess Release Workflow
# Copyright (c) 2026 STARGA, Inc. All rights reserved.
# Downloads FULL protected runtime libraries and builds engine

name: Release

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 3.21.0)'
        required: true
        type: string

permissions:
  contents: write

env:
  NIKOLACHESS_VERSION: "3.21.0"
  MIND_VERSION: "0.1.2"

jobs:
  # ==========================================================================
  # Verify Source and Build Engine
  # ==========================================================================
  build-linux-x64:
    name: Build Linux x64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.mind/bin $HOME/.mind/lib
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-linux-x64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Download Protected Runtime Libraries
        run: |
          # Download FULL protected libraries from current release
          for lib in cpu cuda rocm oneapi webgpu; do
            echo "Downloading libmind_${lib}_linux-x64.so..."
            curl -fsSL -o "$HOME/.mind/lib/libmind_${lib}_linux-x64.so" \
              "https://github.com/star-ga/NikolaChess/releases/download/v${{ env.NIKOLACHESS_VERSION }}/libmind_${lib}_linux-x64.so" || true
          done

          # Verify sizes (FULL libraries are ~5MB+)
          ls -lh $HOME/.mind/lib/

      - name: Verify MIND Source
        run: |
          export MIND_LIB_PATH=$HOME/.mind/lib
          mindc --version
          mindc src/main.mind --verify-only || true
          echo "MIND files: $(find src -name '*.mind' | wc -l)"

      - name: Upload Source
        uses: actions/upload-artifact@v4
        with:
          name: source-linux-x64
          path: src/*.mind

  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-linux-arm64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Verify MIND Source
        run: |
          mindc --version
          mindc src/main.mind --verify-only || true

  build-macos-arm64:
    name: Build macOS ARM64
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-macos-arm64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Verify MIND Source
        run: |
          mindc --version
          mindc src/main.mind --verify-only || true

  build-macos-x64:
    name: Build macOS x64
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler
        run: |
          mkdir -p $HOME/.mind/bin
          curl -fsSL -o /tmp/mindc.tar.gz \
            "https://github.com/star-ga/mind/releases/download/v${{ env.MIND_VERSION }}/mindc-macos-x64.tar.gz"
          tar -xzf /tmp/mindc.tar.gz -C $HOME/.mind/bin/
          chmod +x $HOME/.mind/bin/mindc
          echo "$HOME/.mind/bin" >> $GITHUB_PATH

      - name: Verify MIND Source
        run: |
          mindc --version
          mindc src/main.mind --verify-only || true

  build-windows-x64:
    name: Build Windows x64
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download MIND Compiler
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.mind\bin"
          Invoke-WebRequest -Uri "https://github.com/star-ga/mind/releases/download/v$env:MIND_VERSION/mindc-windows-x64.zip" -OutFile "$env:TEMP\mindc.zip"
          Expand-Archive -Path "$env:TEMP\mindc.zip" -DestinationPath "$env:USERPROFILE\.mind\bin" -Force
          echo "$env:USERPROFILE\.mind\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify MIND Source
        shell: pwsh
        run: |
          & "$env:USERPROFILE\.mind\bin\mindc.exe" --version
          & "$env:USERPROFILE\.mind\bin\mindc.exe" src\main.mind --verify-only
          Write-Host "MIND files: $((Get-ChildItem -Path src -Filter *.mind -Recurse).Count)"
